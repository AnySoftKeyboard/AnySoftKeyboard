---
name: Renovate
on:
  # Run on a schedule (every weekend at 6 AM UTC Saturday)
  schedule:
    - cron: '0 6 * * 6'
  # Allow manual triggers
  workflow_dispatch:
  # Run on pushes to renovate.json to validate configuration
  push:
    paths:
      - '.github/workflows/renovate.yml'
      - '.github/renovate.json'
    branches:
      - main
jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          token: ${{ secrets.BOT_MASTER_RW_GITHUB_TOKEN }}
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.18.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true
      - name: Setup Java
        uses: actions/setup-java@v5.2.0
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      - name: Resolve Paths
        id: paths
        run: |
          echo "java_home=${JAVA_HOME}" >> $GITHUB_OUTPUT
          echo "gradle_user_home=${HOME}/.gradle" >> $GITHUB_OUTPUT
          BAZEL_BIN=$(which bazel)
          BAZEL_REAL_BIN=$(readlink -f "$BAZEL_BIN")
          echo "bazel_bin=$BAZEL_BIN" >> $GITHUB_OUTPUT
          echo "bazel_real_bin=$BAZEL_REAL_BIN" >> $GITHUB_OUTPUT
          echo "bazel_dir=$(dirname $BAZEL_BIN)" >> $GITHUB_OUTPUT
          echo "bazel_cache=${HOME}/.cache/bazel" >> $GITHUB_OUTPUT
          echo "bazelisk_cache=${HOME}/.cache/bazelisk" >> $GITHUB_OUTPUT
      - name: Debug Paths
        run: |
          echo "Java Home: ${{ steps.paths.outputs.java_home }}"
          echo "Gradle User Home: ${{ steps.paths.outputs.gradle_user_home }}"
          echo "Bazel Bin: ${{ steps.paths.outputs.bazel_bin }}"
          echo "Bazel Real Bin: ${{ steps.paths.outputs.bazel_real_bin }}"
          echo "Bazel Dir: ${{ steps.paths.outputs.bazel_dir }}"
          echo "Bazel Cache: ${{ steps.paths.outputs.bazel_cache }}"
          echo "Bazelisk Cache: ${{ steps.paths.outputs.bazelisk_cache }}"
      - name: Self-hosted Renovate
        uses: renovatebot/github-action@v46.0.1
        with:
          configurationFile: .github/renovate.json
          token: ${{ secrets.BOT_MASTER_RW_GITHUB_TOKEN }}
          docker-volumes: |
            ${{ steps.paths.outputs.java_home }}:${{ steps.paths.outputs.java_home }} ;
            ${{ steps.paths.outputs.gradle_user_home }}:${{ steps.paths.outputs.gradle_user_home }} ;
            ${{ steps.paths.outputs.bazel_cache }}:${{ steps.paths.outputs.bazel_cache }} ;
            ${{ steps.paths.outputs.bazelisk_cache }}:${{ steps.paths.outputs.bazelisk_cache }} ;
            ${{ steps.paths.outputs.bazel_bin }}:${{ steps.paths.outputs.bazel_bin }} ;
            ${{ steps.paths.outputs.bazel_real_bin }}:${{ steps.paths.outputs.bazel_real_bin }}
          env-regex: '^(?:RENOVATE_\w+|LOG_LEVEL|JAVA_HOME|GRADLE_USER_HOME|BAZELISK_HOME|PATH)$'
        env:
          LOG_LEVEL: debug
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          JAVA_HOME: ${{ steps.paths.outputs.java_home }}
          GRADLE_USER_HOME: ${{ steps.paths.outputs.gradle_user_home }}
          BAZELISK_HOME: ${{ steps.paths.outputs.bazelisk_cache }}
          PATH: "${{ steps.paths.outputs.java_home }}/bin:${{ steps.paths.outputs.bazel_dir }}:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
