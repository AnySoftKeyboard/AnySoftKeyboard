name: third-party-update

#always run on the default branch: master
on:
  schedule:
    - cron: '29 04 * * *'
  push:
    branches:
      - auto-tools-update

env:
  TERM: dumb
  TMPDIR: "/tmp"
  BOT_USERNAME: ${{ secrets.BOT_MASTER_RW_GITHUB_USERNAME }}
  BOT_TOKEN: ${{ secrets.BOT_MASTER_RW_GITHUB_TOKEN }}

jobs:
  gradle-update:
    runs-on: ubuntu-18.04
    container: menny/ndk_ask:1.13.6
    steps:
      - name: Install deps for create-pull-request
        run: |
          touch /etc/alpine-release
          ln -sf python3 /usr/bin/python
          ln -sf pip3 /usr/bin/pip
      - uses: actions/checkout@v2
      - name: setup
        run: ./scripts/ci/ci_setup.sh
      - name: update-to-latets-gradle
        run: |
          LATEST_VERSION=$(curl --silent -u "${BOT_USERNAME}:${BOT_TOKEN}" https://api.github.com/repos/gradle/gradle/releases\?prerelease\=false | jq -c -r '.[] | select(.prerelease == false) | .name' | head -n 1)
          echo "Found version '${LATEST_VERSION}'."
          ./gradlew wrapper --gradle-version="${LATEST_VERSION}"
      - name: Sanity verification
        run: ./gradlew :api:assembleDebug :api:lintDebug
      - name: Add changed gradle files
        run: |
          git add .
          git add -f gradle/wrapper/gradle-wrapper.jar
      - name: Create pull request
        uses: peter-evans/create-pull-request@v2.4.0
        with:
          token: ${{ secrets.BOT_MASTER_RW_GITHUB_TOKEN }}
          commit-message: 'Automated Gradle Update'
          title: 'Automated Gradle Update'
          committer: 'Polyglot <ask@evendanan.net>'
          author: 'Polyglot <ask@evendanan.net>'
          body: ''
          assignees: menny
          branch: 'bot-pr/gradle-update'
